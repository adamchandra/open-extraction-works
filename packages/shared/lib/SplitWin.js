function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 *
 * Construct a tree of nested windowed panes, where each intermediate node holds a list of child panes,
 *  and the leaves are user content.
 *
 *
 *
 *   .splitwin-root      : root element in hierarchy
 *   .splitwin-pane      : child panes, immediately nested within a div.split-pane-frame
 *
 *
 */
import _ from "lodash";
import $ from "jquery";
import Split from "split.js";
import { $id, t, htm } from "./tstags";

const noop = function () {
  return;
};

export const SPLIT_OPTIONS = {
  sizes: [],
  // Array 		                      Initial sizes of each element in percents or CSS values.
  minSize: [],
  // Number or Array 	100 	        Minimum size of each element.
  gutterSize: 0,
  // Number 	          10 	          Gutter size in pixels.
  snapOffset: 0,
  // Number 	          30  	        Snap to minimum size offset in pixels.
  direction: "vertical",
  // String 	         'horizontal' 	Direction to split: horizontal or vertical.
  cursor: "col-resize",
  // String 	         'col-resize' 	Cursor to display while dragging.
  gutter: noop,
  // Function 		                    Called to create each gutter element
  elementStyle: noop,
  // Function 		                    Called to set the style of each element.
  gutterStyle: noop,
  // Function 		                    Called to set the style of the gutter.
  onDrag: noop,
  // Function 		                    Callback on drag.
  onDragStart: noop,
  // Function 		                    Callback on drag start.
  onDragEnd: noop // Function 		                    Callback on drag end.

};
const splitPaneRootId = "splitwin_root";
export let FrameFlowDir;

(function (FrameFlowDir) {
  FrameFlowDir[FrameFlowDir["Row"] = 0] = "Row";
  FrameFlowDir[FrameFlowDir["Col"] = 1] = "Col";
})(FrameFlowDir || (FrameFlowDir = {}));

class Frame {
  // private paneIds: string[] = [];
  constructor($elem) {
    _defineProperty(this, "elem", void 0);

    _defineProperty(this, "frameId", void 0);

    _defineProperty(this, "direction", void 0);

    _defineProperty(this, "split", void 0);

    _defineProperty(this, "panes", []);

    this.elem = $elem;
    this.frameId = $elem.attr("id");
    this.direction = FrameFlowDir.Col;
  }

  setDirection(dir) {
    const cdiv = this.childrenDiv();
    this.direction = dir;

    if (dir === FrameFlowDir.Row) {
      cdiv.addClass("splitwin-row");
      cdiv.removeClass("splitwin-column");
    } else if (dir === FrameFlowDir.Col) {
      cdiv.addClass("splitwin-column");
      cdiv.removeClass("splitwin-row");
    } else {
      throw Error(`unknown direction ${dir}`);
    }
  }

  clientAreaSelector() {
    return `#${this.frameId} > .frame-content`;
  }

  clientArea() {
    return $(this.clientAreaSelector());
  }

  childrenDiv() {
    return $id(this.frameId).children(".frame-content");
  }

  getChildren() {
    return this.panes;
  }

  getSplitDir() {
    return this.direction === FrameFlowDir.Col ? "vertical" : "horizontal";
  }

  getParentPane() {
    // console.log('getParentPane', this.frameId);
    const idParts = this.frameId.split(/__/); // console.log('idParts', idParts);

    const parentId = idParts.slice(0, idParts.length - 1).join("__"); // console.log('parentId', parentId);

    return parentId;
  }

  addPanes(n) {
    const paneIds = generatePaneIds(this.frameId, n);

    const panes = _.map(paneIds, id => mkPane(id));

    const paneElems = _.map(panes, p => p.elem);

    this.childrenDiv().append(paneElems);
    this.rebuild();
    return panes;
  }

  rebuild() {
    const ch = this.childrenDiv().children(); // console.log('rebuild: ch', ch);

    const childPanes = ch.filter(function () {
      return $(this).is(".splitwin-pane");
    }); // console.log('rebuild: childPanes len=', childPanes.length);

    const paneIds = _.map(childPanes.toArray(), p => {
      return $(p).attr("id");
    });

    const panes = _.map(childPanes.toArray(), p => {
      return $(p).prop("SplitWin");
    }); // console.log('rebuild: panes', panes);


    const paneSelectors = _.map(paneIds, id => `#${id}`); // const paneElems = _.map(panes, p => p.elem);
    // console.log('rebuild: paneSelectors = ', paneSelectors.join(', '));


    const size = Math.floor(100 / paneIds.length);

    const sizes = _.map(_.range(0, paneIds.length), () => size); // console.log('rebuild: sizes = ', sizes.join(', '));


    if (this.split !== undefined) {
      this.split.destroy();
    } // $e.children('.children').empty();
    // $e.children('.children').append(paneElems);


    this.split = Split(paneSelectors, {
      sizes,
      direction: this.getSplitDir(),
      gutterSize: 6,
      minSize: 10
    }); // this.paneIds = paneIds;

    this.panes = panes; // this.updateSplit(split);
  }

  updateSplit(split) {
    if (this.split !== undefined) {
      this.split.destroy();
    }

    this.split = split;
  }

  addPaneControls() {
    const self = this;
    const exp = htm.iconButton("expand");
    const comp = htm.iconButton("compress");
    const del = htm.iconButton("times");
    const controls = t.div(".splitwin-controls", [exp, comp, del]);
    del.on("click", () => {
      self.delete();
    });
    $id(this.frameId).addClass("controls");
    $id(this.frameId).children(".status-top").append(controls);
  }

  delete() {
    this.updateSplit(undefined);
    $id(this.frameId).remove();
    const parentPaneId = this.getParentPane();
    const parentSplitWin = $id(parentPaneId).prop("SplitWin");
    parentSplitWin.rebuild();
  }

  maximize() {}

  restoreSize() {}

}

export function createRootFrame(containerId) {
  const root = mkPane(splitPaneRootId);
  root.elem.addClass("splitwin-root");
  $(containerId).append(root.elem);
  $(containerId).css({
    overflow: "hidden"
  });
  return root;
}

function mkPane(id) {
  const elem = t.div(`#${id} .splitwin-pane`, [t.div(`.status-top`), t.div(`.left-gutter`), t.div(`.frame-content`), t.div(`.right-gutter`), t.div(`.status-bottom`)]);
  const frame = new Frame(elem);
  elem.prop("SplitWin", frame);
  return frame;
} // export function makePaneId(...indexes) {
//   const paneId = _.join(
//     _.map(indexes, i => {
//       return `pane-${i}`;
//     }),
//     '__'
//   );
//   return `${splitPaneRootId}__${paneId}`;
// }


function generatePaneIds(parentId, n) {
  return _.map(_.range(0, n), id => {
    return `${parentId}__pane-${id}`;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcGxpdFdpbi50cyJdLCJuYW1lcyI6WyJfIiwiJCIsIlNwbGl0IiwiJGlkIiwidCIsImh0bSIsIm5vb3AiLCJTUExJVF9PUFRJT05TIiwic2l6ZXMiLCJtaW5TaXplIiwiZ3V0dGVyU2l6ZSIsInNuYXBPZmZzZXQiLCJkaXJlY3Rpb24iLCJjdXJzb3IiLCJndXR0ZXIiLCJlbGVtZW50U3R5bGUiLCJndXR0ZXJTdHlsZSIsIm9uRHJhZyIsIm9uRHJhZ1N0YXJ0Iiwib25EcmFnRW5kIiwic3BsaXRQYW5lUm9vdElkIiwiRnJhbWVGbG93RGlyIiwiRnJhbWUiLCJjb25zdHJ1Y3RvciIsIiRlbGVtIiwiZWxlbSIsImZyYW1lSWQiLCJhdHRyIiwiQ29sIiwic2V0RGlyZWN0aW9uIiwiZGlyIiwiY2RpdiIsImNoaWxkcmVuRGl2IiwiUm93IiwiYWRkQ2xhc3MiLCJyZW1vdmVDbGFzcyIsIkVycm9yIiwiY2xpZW50QXJlYVNlbGVjdG9yIiwiY2xpZW50QXJlYSIsImNoaWxkcmVuIiwiZ2V0Q2hpbGRyZW4iLCJwYW5lcyIsImdldFNwbGl0RGlyIiwiZ2V0UGFyZW50UGFuZSIsImlkUGFydHMiLCJzcGxpdCIsInBhcmVudElkIiwic2xpY2UiLCJsZW5ndGgiLCJqb2luIiwiYWRkUGFuZXMiLCJuIiwicGFuZUlkcyIsImdlbmVyYXRlUGFuZUlkcyIsIm1hcCIsImlkIiwibWtQYW5lIiwicGFuZUVsZW1zIiwicCIsImFwcGVuZCIsInJlYnVpbGQiLCJjaCIsImNoaWxkUGFuZXMiLCJmaWx0ZXIiLCJpcyIsInRvQXJyYXkiLCJwcm9wIiwicGFuZVNlbGVjdG9ycyIsInNpemUiLCJNYXRoIiwiZmxvb3IiLCJyYW5nZSIsInVuZGVmaW5lZCIsImRlc3Ryb3kiLCJ1cGRhdGVTcGxpdCIsImFkZFBhbmVDb250cm9scyIsInNlbGYiLCJleHAiLCJpY29uQnV0dG9uIiwiY29tcCIsImRlbCIsImNvbnRyb2xzIiwiZGl2Iiwib24iLCJkZWxldGUiLCJyZW1vdmUiLCJwYXJlbnRQYW5lSWQiLCJwYXJlbnRTcGxpdFdpbiIsIm1heGltaXplIiwicmVzdG9yZVNpemUiLCJjcmVhdGVSb290RnJhbWUiLCJjb250YWluZXJJZCIsInJvb3QiLCJjc3MiLCJvdmVyZmxvdyIsImZyYW1lIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7Ozs7Ozs7QUFhQSxPQUFPQSxDQUFQLE1BQWMsUUFBZDtBQUNBLE9BQU9DLENBQVAsTUFBYyxRQUFkO0FBRUEsT0FBT0MsS0FBUCxNQUFrQixVQUFsQjtBQUNBLFNBQVFDLEdBQVIsRUFBYUMsQ0FBYixFQUFnQkMsR0FBaEIsUUFBMEIsVUFBMUI7O0FBRUEsTUFBTUMsSUFBSSxHQUFHLFlBQVc7QUFDdEI7QUFDRCxDQUZEOztBQUlBLE9BQU8sTUFBTUMsYUFBYSxHQUFHO0FBQzNCQyxFQUFBQSxLQUFLLEVBQUUsRUFEb0I7QUFDaEI7QUFDWEMsRUFBQUEsT0FBTyxFQUFFLEVBRmtCO0FBRWQ7QUFDYkMsRUFBQUEsVUFBVSxFQUFFLENBSGU7QUFHWjtBQUNmQyxFQUFBQSxVQUFVLEVBQUUsQ0FKZTtBQUlaO0FBQ2ZDLEVBQUFBLFNBQVMsRUFBRSxVQUxnQjtBQUtKO0FBQ3ZCQyxFQUFBQSxNQUFNLEVBQUUsWUFObUI7QUFNTDtBQUN0QkMsRUFBQUEsTUFBTSxFQUFFUixJQVBtQjtBQU9iO0FBQ2RTLEVBQUFBLFlBQVksRUFBRVQsSUFSYTtBQVFQO0FBQ3BCVSxFQUFBQSxXQUFXLEVBQUVWLElBVGM7QUFTUjtBQUNuQlcsRUFBQUEsTUFBTSxFQUFFWCxJQVZtQjtBQVViO0FBQ2RZLEVBQUFBLFdBQVcsRUFBRVosSUFYYztBQVdSO0FBQ25CYSxFQUFBQSxTQUFTLEVBQUViLElBWmdCLENBWVY7O0FBWlUsQ0FBdEI7QUFlUCxNQUFNYyxlQUFlLEdBQUcsZUFBeEI7QUFFQSxXQUFZQyxZQUFaOztXQUFZQSxZO0FBQUFBLEVBQUFBLFksQ0FBQUEsWTtBQUFBQSxFQUFBQSxZLENBQUFBLFk7R0FBQUEsWSxLQUFBQSxZOztBQUtaLE1BQU1DLEtBQU4sQ0FB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RSxHQUFGLENBQU8sZ0JBQVAsQ0FMMEMsQ0FBL0IsQ0FBYjtBQVFBLFFBQU1hLEtBQUssR0FBRyxJQUFJekUsS0FBSixDQUFVRyxJQUFWLENBQWQ7QUFDQUEsRUFBQUEsSUFBSSxDQUFDeUMsSUFBTCxDQUFVLFVBQVYsRUFBc0I2QixLQUF0QjtBQUNBLFNBQU9BLEtBQVA7QUFDRCxDLENBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFFQSxTQUFTMUMsZUFBVCxDQUF5QlAsUUFBekIsRUFBMkNLLENBQTNDLEVBQWdFO0FBQzlELFNBQU9uRCxDQUFDLENBQUNzRCxHQUFGLENBQU10RCxDQUFDLENBQUN1RSxLQUFGLENBQVEsQ0FBUixFQUFXcEIsQ0FBWCxDQUFOLEVBQXFCSSxFQUFFLElBQUk7QUFDaEMsV0FBUSxHQUFFVCxRQUFTLFVBQVNTLEVBQUcsRUFBL0I7QUFDRCxHQUZNLENBQVA7QUFHRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIENvbnN0cnVjdCBhIHRyZWUgb2YgbmVzdGVkIHdpbmRvd2VkIHBhbmVzLCB3aGVyZSBlYWNoIGludGVybWVkaWF0ZSBub2RlIGhvbGRzIGEgbGlzdCBvZiBjaGlsZCBwYW5lcyxcbiAqICBhbmQgdGhlIGxlYXZlcyBhcmUgdXNlciBjb250ZW50LlxuICpcbiAqXG4gKlxuICogICAuc3BsaXR3aW4tcm9vdCAgICAgIDogcm9vdCBlbGVtZW50IGluIGhpZXJhcmNoeVxuICogICAuc3BsaXR3aW4tcGFuZSAgICAgIDogY2hpbGQgcGFuZXMsIGltbWVkaWF0ZWx5IG5lc3RlZCB3aXRoaW4gYSBkaXYuc3BsaXQtcGFuZS1mcmFtZVxuICpcbiAqXG4gKi9cblxuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICQgZnJvbSBcImpxdWVyeVwiO1xuXG5pbXBvcnQgU3BsaXQgZnJvbSBcInNwbGl0LmpzXCI7XG5pbXBvcnQgeyRpZCwgdCwgaHRtfSBmcm9tIFwiLi90c3RhZ3NcIjtcblxuY29uc3Qgbm9vcCA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm47XG59O1xuXG5leHBvcnQgY29uc3QgU1BMSVRfT1BUSU9OUyA9IHtcbiAgc2l6ZXM6IFtdLCAvLyBBcnJheSBcdFx0ICAgICAgICAgICAgICAgICAgICAgIEluaXRpYWwgc2l6ZXMgb2YgZWFjaCBlbGVtZW50IGluIHBlcmNlbnRzIG9yIENTUyB2YWx1ZXMuXG4gIG1pblNpemU6IFtdLCAvLyBOdW1iZXIgb3IgQXJyYXkgXHQxMDAgXHQgICAgICAgIE1pbmltdW0gc2l6ZSBvZiBlYWNoIGVsZW1lbnQuXG4gIGd1dHRlclNpemU6IDAsIC8vIE51bWJlciBcdCAgICAgICAgICAxMCBcdCAgICAgICAgICBHdXR0ZXIgc2l6ZSBpbiBwaXhlbHMuXG4gIHNuYXBPZmZzZXQ6IDAsIC8vIE51bWJlciBcdCAgICAgICAgICAzMCAgXHQgICAgICAgIFNuYXAgdG8gbWluaW11bSBzaXplIG9mZnNldCBpbiBwaXhlbHMuXG4gIGRpcmVjdGlvbjogXCJ2ZXJ0aWNhbFwiLCAvLyBTdHJpbmcgXHQgICAgICAgICAnaG9yaXpvbnRhbCcgXHREaXJlY3Rpb24gdG8gc3BsaXQ6IGhvcml6b250YWwgb3IgdmVydGljYWwuXG4gIGN1cnNvcjogXCJjb2wtcmVzaXplXCIsIC8vIFN0cmluZyBcdCAgICAgICAgICdjb2wtcmVzaXplJyBcdEN1cnNvciB0byBkaXNwbGF5IHdoaWxlIGRyYWdnaW5nLlxuICBndXR0ZXI6IG5vb3AsIC8vIEZ1bmN0aW9uIFx0XHQgICAgICAgICAgICAgICAgICAgIENhbGxlZCB0byBjcmVhdGUgZWFjaCBndXR0ZXIgZWxlbWVudFxuICBlbGVtZW50U3R5bGU6IG5vb3AsIC8vIEZ1bmN0aW9uIFx0XHQgICAgICAgICAgICAgICAgICAgIENhbGxlZCB0byBzZXQgdGhlIHN0eWxlIG9mIGVhY2ggZWxlbWVudC5cbiAgZ3V0dGVyU3R5bGU6IG5vb3AsIC8vIEZ1bmN0aW9uIFx0XHQgICAgICAgICAgICAgICAgICAgIENhbGxlZCB0byBzZXQgdGhlIHN0eWxlIG9mIHRoZSBndXR0ZXIuXG4gIG9uRHJhZzogbm9vcCwgLy8gRnVuY3Rpb24gXHRcdCAgICAgICAgICAgICAgICAgICAgQ2FsbGJhY2sgb24gZHJhZy5cbiAgb25EcmFnU3RhcnQ6IG5vb3AsIC8vIEZ1bmN0aW9uIFx0XHQgICAgICAgICAgICAgICAgICAgIENhbGxiYWNrIG9uIGRyYWcgc3RhcnQuXG4gIG9uRHJhZ0VuZDogbm9vcCwgLy8gRnVuY3Rpb24gXHRcdCAgICAgICAgICAgICAgICAgICAgQ2FsbGJhY2sgb24gZHJhZyBlbmQuXG59O1xuXG5jb25zdCBzcGxpdFBhbmVSb290SWQgPSBcInNwbGl0d2luX3Jvb3RcIjtcblxuZXhwb3J0IGVudW0gRnJhbWVGbG93RGlyIHtcbiAgUm93LFxuICBDb2wsXG59XG5cbmNsYXNzIEZyYW1lIHtcbiAgcHVibGljIGVsZW06IEpRdWVyeTxFbGVtZW50PjtcbiAgcHJpdmF0ZSBmcmFtZUlkOiBzdHJpbmc7XG4gIHByaXZhdGUgZGlyZWN0aW9uOiBGcmFtZUZsb3dEaXI7XG4gIHByaXZhdGUgc3BsaXQ/OiBTcGxpdC5JbnN0YW5jZTtcbiAgcHJpdmF0ZSBwYW5lczogRnJhbWVbXSA9IFtdO1xuICAvLyBwcml2YXRlIHBhbmVJZHM6IHN0cmluZ1tdID0gW107XG5cbiAgY29uc3RydWN0b3IoJGVsZW06IEpRdWVyeSkge1xuICAgIHRoaXMuZWxlbSA9ICRlbGVtO1xuICAgIHRoaXMuZnJhbWVJZCA9ICRlbGVtLmF0dHIoXCJpZFwiKSE7XG4gICAgdGhpcy5kaXJlY3Rpb24gPSBGcmFtZUZsb3dEaXIuQ29sO1xuICB9XG5cbiAgc2V0RGlyZWN0aW9uKGRpcjogRnJhbWVGbG93RGlyKSB7XG4gICAgY29uc3QgY2RpdiA9IHRoaXMuY2hpbGRyZW5EaXYoKTtcbiAgICB0aGlzLmRpcmVjdGlvbiA9IGRpcjtcbiAgICBpZiAoZGlyID09PSBGcmFtZUZsb3dEaXIuUm93KSB7XG4gICAgICBjZGl2LmFkZENsYXNzKFwic3BsaXR3aW4tcm93XCIpO1xuICAgICAgY2Rpdi5yZW1vdmVDbGFzcyhcInNwbGl0d2luLWNvbHVtblwiKTtcbiAgICB9IGVsc2UgaWYgKGRpciA9PT0gRnJhbWVGbG93RGlyLkNvbCkge1xuICAgICAgY2Rpdi5hZGRDbGFzcyhcInNwbGl0d2luLWNvbHVtblwiKTtcbiAgICAgIGNkaXYucmVtb3ZlQ2xhc3MoXCJzcGxpdHdpbi1yb3dcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEVycm9yKGB1bmtub3duIGRpcmVjdGlvbiAke2Rpcn1gKTtcbiAgICB9XG4gIH1cblxuICBjbGllbnRBcmVhU2VsZWN0b3IoKSB7XG4gICAgcmV0dXJuIGAjJHt0aGlzLmZyYW1lSWR9ID4gLmZyYW1lLWNvbnRlbnRgO1xuICB9XG5cbiAgY2xpZW50QXJlYSgpIHtcbiAgICByZXR1cm4gJCh0aGlzLmNsaWVudEFyZWFTZWxlY3RvcigpKTtcbiAgfVxuXG4gIGNoaWxkcmVuRGl2KCkge1xuICAgIHJldHVybiAkaWQodGhpcy5mcmFtZUlkKS5jaGlsZHJlbihcIi5mcmFtZS1jb250ZW50XCIpO1xuICB9XG5cbiAgZ2V0Q2hpbGRyZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMucGFuZXM7XG4gIH1cblxuICBnZXRTcGxpdERpcigpIHtcbiAgICByZXR1cm4gdGhpcy5kaXJlY3Rpb24gPT09IEZyYW1lRmxvd0Rpci5Db2wgPyBcInZlcnRpY2FsXCIgOiBcImhvcml6b250YWxcIjtcbiAgfVxuXG4gIGdldFBhcmVudFBhbmUoKSB7XG4gICAgLy8gY29uc29sZS5sb2coJ2dldFBhcmVudFBhbmUnLCB0aGlzLmZyYW1lSWQpO1xuXG4gICAgY29uc3QgaWRQYXJ0cyA9IHRoaXMuZnJhbWVJZC5zcGxpdCgvX18vKTtcbiAgICAvLyBjb25zb2xlLmxvZygnaWRQYXJ0cycsIGlkUGFydHMpO1xuICAgIGNvbnN0IHBhcmVudElkID0gaWRQYXJ0cy5zbGljZSgwLCBpZFBhcnRzLmxlbmd0aCAtIDEpLmpvaW4oXCJfX1wiKTtcbiAgICAvLyBjb25zb2xlLmxvZygncGFyZW50SWQnLCBwYXJlbnRJZCk7XG4gICAgcmV0dXJuIHBhcmVudElkO1xuICB9XG5cbiAgYWRkUGFuZXMobjogbnVtYmVyKSB7XG4gICAgY29uc3QgcGFuZUlkcyA9IGdlbmVyYXRlUGFuZUlkcyh0aGlzLmZyYW1lSWQsIG4pO1xuICAgIGNvbnN0IHBhbmVzID0gXy5tYXAocGFuZUlkcywgaWQgPT4gbWtQYW5lKGlkKSk7XG4gICAgY29uc3QgcGFuZUVsZW1zID0gXy5tYXAocGFuZXMsIHAgPT4gcC5lbGVtKTtcblxuICAgIHRoaXMuY2hpbGRyZW5EaXYoKS5hcHBlbmQocGFuZUVsZW1zKTtcblxuICAgIHRoaXMucmVidWlsZCgpO1xuICAgIHJldHVybiBwYW5lcztcbiAgfVxuXG4gIHJlYnVpbGQoKSB7XG4gICAgY29uc3QgY2ggPSB0aGlzLmNoaWxkcmVuRGl2KCkuY2hpbGRyZW4oKTtcbiAgICAvLyBjb25zb2xlLmxvZygncmVidWlsZDogY2gnLCBjaCk7XG5cbiAgICBjb25zdCBjaGlsZFBhbmVzID0gY2guZmlsdGVyKGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuICQodGhpcykuaXMoXCIuc3BsaXR3aW4tcGFuZVwiKTtcbiAgICB9KTtcblxuICAgIC8vIGNvbnNvbGUubG9nKCdyZWJ1aWxkOiBjaGlsZFBhbmVzIGxlbj0nLCBjaGlsZFBhbmVzLmxlbmd0aCk7XG5cbiAgICBjb25zdCBwYW5lSWRzID0gXy5tYXAoY2hpbGRQYW5lcy50b0FycmF5KCksIHAgPT4ge1xuICAgICAgcmV0dXJuICQocCkuYXR0cihcImlkXCIpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcGFuZXMgPSBfLm1hcChjaGlsZFBhbmVzLnRvQXJyYXkoKSwgcCA9PiB7XG4gICAgICByZXR1cm4gJChwKS5wcm9wKFwiU3BsaXRXaW5cIik7XG4gICAgfSk7XG4gICAgLy8gY29uc29sZS5sb2coJ3JlYnVpbGQ6IHBhbmVzJywgcGFuZXMpO1xuXG4gICAgY29uc3QgcGFuZVNlbGVjdG9ycyA9IF8ubWFwKHBhbmVJZHMsIGlkID0+IGAjJHtpZH1gKTtcblxuICAgIC8vIGNvbnN0IHBhbmVFbGVtcyA9IF8ubWFwKHBhbmVzLCBwID0+IHAuZWxlbSk7XG5cbiAgICAvLyBjb25zb2xlLmxvZygncmVidWlsZDogcGFuZVNlbGVjdG9ycyA9ICcsIHBhbmVTZWxlY3RvcnMuam9pbignLCAnKSk7XG5cbiAgICBjb25zdCBzaXplID0gTWF0aC5mbG9vcigxMDAgLyBwYW5lSWRzLmxlbmd0aCk7XG5cbiAgICBjb25zdCBzaXplcyA9IF8ubWFwKF8ucmFuZ2UoMCwgcGFuZUlkcy5sZW5ndGgpLCAoKSA9PiBzaXplKTtcblxuICAgIC8vIGNvbnNvbGUubG9nKCdyZWJ1aWxkOiBzaXplcyA9ICcsIHNpemVzLmpvaW4oJywgJykpO1xuXG4gICAgaWYgKHRoaXMuc3BsaXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5zcGxpdC5kZXN0cm95KCk7XG4gICAgfVxuXG4gICAgLy8gJGUuY2hpbGRyZW4oJy5jaGlsZHJlbicpLmVtcHR5KCk7XG4gICAgLy8gJGUuY2hpbGRyZW4oJy5jaGlsZHJlbicpLmFwcGVuZChwYW5lRWxlbXMpO1xuXG4gICAgdGhpcy5zcGxpdCA9IFNwbGl0KHBhbmVTZWxlY3RvcnMsIHtcbiAgICAgIHNpemVzLFxuICAgICAgZGlyZWN0aW9uOiB0aGlzLmdldFNwbGl0RGlyKCksXG4gICAgICBndXR0ZXJTaXplOiA2LFxuICAgICAgbWluU2l6ZTogMTAsXG4gICAgfSk7XG5cbiAgICAvLyB0aGlzLnBhbmVJZHMgPSBwYW5lSWRzO1xuICAgIHRoaXMucGFuZXMgPSBwYW5lcztcbiAgICAvLyB0aGlzLnVwZGF0ZVNwbGl0KHNwbGl0KTtcbiAgfVxuXG4gIHVwZGF0ZVNwbGl0KHNwbGl0PzogU3BsaXQuSW5zdGFuY2UpIHtcbiAgICBpZiAodGhpcy5zcGxpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnNwbGl0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgdGhpcy5zcGxpdCA9IHNwbGl0O1xuICB9XG5cbiAgYWRkUGFuZUNvbnRyb2xzKCkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGNvbnN0IGV4cCA9IGh0bS5pY29uQnV0dG9uKFwiZXhwYW5kXCIpO1xuICAgIGNvbnN0IGNvbXAgPSBodG0uaWNvbkJ1dHRvbihcImNvbXByZXNzXCIpO1xuICAgIGNvbnN0IGRlbCA9IGh0bS5pY29uQnV0dG9uKFwidGltZXNcIik7XG4gICAgY29uc3QgY29udHJvbHMgPSB0LmRpdihcIi5zcGxpdHdpbi1jb250cm9sc1wiLCBbZXhwLCBjb21wLCBkZWxdKTtcblxuICAgIGRlbC5vbihcImNsaWNrXCIsICgpID0+IHtcbiAgICAgIHNlbGYuZGVsZXRlKCk7XG4gICAgfSk7XG5cbiAgICAkaWQodGhpcy5mcmFtZUlkKS5hZGRDbGFzcyhcImNvbnRyb2xzXCIpO1xuXG4gICAgJGlkKHRoaXMuZnJhbWVJZClcbiAgICAgIC5jaGlsZHJlbihcIi5zdGF0dXMtdG9wXCIpXG4gICAgICAuYXBwZW5kKGNvbnRyb2xzKTtcbiAgfVxuXG4gIGRlbGV0ZSgpIHtcbiAgICB0aGlzLnVwZGF0ZVNwbGl0KHVuZGVmaW5lZCk7XG4gICAgJGlkKHRoaXMuZnJhbWVJZCkucmVtb3ZlKCk7XG4gICAgY29uc3QgcGFyZW50UGFuZUlkID0gdGhpcy5nZXRQYXJlbnRQYW5lKCk7XG4gICAgY29uc3QgcGFyZW50U3BsaXRXaW4gPSAkaWQocGFyZW50UGFuZUlkKS5wcm9wKFwiU3BsaXRXaW5cIik7XG4gICAgcGFyZW50U3BsaXRXaW4ucmVidWlsZCgpO1xuICB9XG5cbiAgbWF4aW1pemUoKSB7fVxuXG4gIHJlc3RvcmVTaXplKCkge31cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJvb3RGcmFtZShjb250YWluZXJJZDogc3RyaW5nKSB7XG4gIGNvbnN0IHJvb3QgPSBta1BhbmUoc3BsaXRQYW5lUm9vdElkKTtcbiAgcm9vdC5lbGVtLmFkZENsYXNzKFwic3BsaXR3aW4tcm9vdFwiKTtcbiAgJChjb250YWluZXJJZCkuYXBwZW5kKHJvb3QuZWxlbSk7XG4gICQoY29udGFpbmVySWQpLmNzcyh7XG4gICAgb3ZlcmZsb3c6IFwiaGlkZGVuXCIsXG4gIH0pO1xuXG4gIHJldHVybiByb290O1xufVxuXG5mdW5jdGlvbiBta1BhbmUoaWQ6IHN0cmluZykge1xuICBjb25zdCBlbGVtID0gdC5kaXYoYCMke2lkfSAuc3BsaXR3aW4tcGFuZWAsIFtcbiAgICB0LmRpdihgLnN0YXR1cy10b3BgKSxcbiAgICB0LmRpdihgLmxlZnQtZ3V0dGVyYCksXG4gICAgdC5kaXYoYC5mcmFtZS1jb250ZW50YCksXG4gICAgdC5kaXYoYC5yaWdodC1ndXR0ZXJgKSxcbiAgICB0LmRpdihgLnN0YXR1cy1ib3R0b21gKSxcbiAgXSk7XG5cbiAgY29uc3QgZnJhbWUgPSBuZXcgRnJhbWUoZWxlbSk7XG4gIGVsZW0ucHJvcChcIlNwbGl0V2luXCIsIGZyYW1lKTtcbiAgcmV0dXJuIGZyYW1lO1xufVxuXG4vLyBleHBvcnQgZnVuY3Rpb24gbWFrZVBhbmVJZCguLi5pbmRleGVzKSB7XG4vLyAgIGNvbnN0IHBhbmVJZCA9IF8uam9pbihcbi8vICAgICBfLm1hcChpbmRleGVzLCBpID0+IHtcbi8vICAgICAgIHJldHVybiBgcGFuZS0ke2l9YDtcbi8vICAgICB9KSxcbi8vICAgICAnX18nXG4vLyAgICk7XG4vLyAgIHJldHVybiBgJHtzcGxpdFBhbmVSb290SWR9X18ke3BhbmVJZH1gO1xuLy8gfVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVBhbmVJZHMocGFyZW50SWQ6IHN0cmluZywgbjogbnVtYmVyKTogc3RyaW5nW10ge1xuICByZXR1cm4gXy5tYXAoXy5yYW5nZSgwLCBuKSwgaWQgPT4ge1xuICAgIHJldHVybiBgJHtwYXJlbnRJZH1fX3BhbmUtJHtpZH1gO1xuICB9KTtcbn1cbiJdfQ==